# Copyright 2024 Iguazio
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Update uv lock files

on:
  workflow_dispatch:
  schedule:
  - cron: "0 4 * * 0"  # At 4 AM UTC on every Sunday

jobs:
  upgrade:
    name: Upgrade uv lock files
    runs-on: ubuntu-latest
    if: github.repository_owner == 'mlrun'
    steps:
    - uses: actions/checkout@v4
    - name: Get uv version from the Makefile
      id: uv-version
      run: |
        version=$(grep "MLRUN_UV_VERSION ?=" Makefile | cut -d' ' -f3)
        echo version=$version >> "$GITHUB_OUTPUT"
    - uses: astral-sh/setup-uv@v5
      with:
        version: ${{ steps.uv-version.outputs.version }}
    - name: Upgrade dependencies in the lock file with uv
      run: make upgrade-mlrun-deps-lock
    - uses: peter-evans/create-pull-request@v7
      with:
        title: "[Requirements-automated] Upgrade lock files"
        body: |
          Update the uv generated lock files.
          Generated by the run:
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        commit-message: Upgrade uv lock files
        branch: automated/uv-lock-upgrade
        delete-branch: true
        # See:
        # https://github.com/peter-evans/create-pull-request?tab=readme-ov-file#token
        # Fine-grained Personal Access Token (PAT) with contents: write and pull-requests: write scopes.
        token: ${{ secrets.MLRUN_PR_PAT }}
